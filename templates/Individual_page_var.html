<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>{{ title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/screen.css') }}">
    <script src="{{ url_for('static', filename='js/jquery-3.1.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.detect_swipe.js') }}"></script>
    <script src="{{ url_for('static', filename='js/helper.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <style>
      /* ===================== HEADER like FOOTER (BLACK BAR) ===================== */
      header.site {
        background-color: #000;    /* black background */
        color: #fff;               /* white text */
        padding: 20px 0;           /* vertical padding */
        margin: 0;                 /* no extra margin */
        text-align: center;        /* center everything */
        display: flex;
        justify-content: center;
        align-items: center;
      }

      header.site h1#header-title {
        font-size: 32px;           /* BIG title like you wanted */
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
        color: #fff;               /* white text */
      }

      /* optional: logo on the left if needed */
      header.site #header-logo {
        position: absolute;        /* stays left */
        left: 20px;
      }

      header.site #header-logo img {
        height: 46px;
        width: auto;
        background-color: #fff;    /* optional white background */
        padding: 4px;
        border-radius: 4px;
      }

      /* ===================== BODY ===================== */
      body {
        font-family: Arial, sans-serif;
        background-color: #f9f9f9;
        padding: 20px;
      }

      /* ===================== CONTAINER ===================== */
      .container {
        margin: 10px auto;   /* reduce gap between header and table */
        gap: 14px;
        display: flex;
        align-items: flex-start;
        max-width: 1300px;
      }

      .portrait {
        width: 260px;
        height: 260px;
        max-width: 35vw;
        max-height: 35vw;
        object-fit: contain;
        background-color: #eeeeee;
        border-radius: 8px;
        border: 2px solid black;
        flex-shrink: 0;
      }

      .text {
        flex-grow: 1;
        border: 2px solid black;
        padding: 20px;
        border-radius: 8px;
        font-size: 18px;
        box-sizing: border-box;
      }

      h2 {
        text-align: center;
        margin-top: 10px;   /* smaller gap above table */
        margin-bottom: 10px; /* smaller gap below header */
        color: #333333;
      }

      /* ===================== TABLE ===================== */
      table.property-table {
        width: 95%;
        margin: 10px auto;
        border-collapse: collapse;
        background-color: #ffffff;
        font-size: 14px;
      }

      table.property-table th,
      table.property-table td {
        border: 1px solid #bbb;
        padding: 6px 8px;
        vertical-align: top;
        line-height: 1.3;
      }

      table.property-table th {
        background-color: #f0f0f0;
        font-weight: 600;
        text-align: left;
      }

      table.property-table tr:nth-child(even) {
        background-color: #f5f5f5;
      }

      table.property-table a {
        color: #0645AD;
        text-decoration: underline;
      }

      /* ===================== TRAFFIC LIGHT ===================== */
      .traffic-light {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        cursor: pointer;
        border: 1px solid #333;
      }

      .red { background: #c0392b; }
      .yellow { background: #f1c40f; }
      .green { background: #27ae60; }
      .gray { background: #ccc; }

      /* ===================== FOOTER ===================== */
      footer.site {
        margin-top: 40px;
        text-align: center;
        background-color: #000;
        color: #fff;
        padding: 15px 0;
      }

      footer.site a {
        margin: 0 10px;
        text-decoration: none;
        color: #fff;
      }

      /* ===================== BUTTONS ===================== */
      .btn {
        padding: 12px 28px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        margin: 0 10px 10px 10px;
        transition: all 0.2s ease;
        color: white;
      }

      .btn-edit { background-color: #3498db; }
      .btn-edit:hover { background-color: #2980b9; }

      .btn-save { background-color: #27ae60; }
      .btn-save:hover { background-color: #1e8449; }

      .btn-review { background-color: #e67e22; }
      .btn-review:hover { background-color: #d35400; }

      .btn-refresh { background-color: #7f8c8d; }
      .btn-refresh:hover { background-color: #606f73; }


      /* Light background based on traffic light */
.value-cell.red, .value-editor.red {
  background-color: #fdecea;  /* very light red */
}

.value-cell.yellow, .value-editor.yellow {
  background-color: #fffbe6;  /* very light yellow */
}

.value-cell.green, .value-editor.green {
  background-color: #eafaf1;  /* very light green */
}

.value-cell.gray, .value-editor.gray {
  background-color: #f9f9f9;  /* neutral */
}


    </style>
</head>


  <body class="bundle list">
    <header class="site">
      <a id="header-logo" href="{{ url_for('visual_art') }}">
        <img class="logo" src="{{ url_for('static', filename='images/Uni_Marburg_Siegel.png') }}" alt="Uni Marburg Logo">
      </a>
      <h1 id="header-title">{{ title }}</h1>
    </header>
    <div class="container">
      <img class="portrait" src="{{ url_for('static', filename=image_path if image_path and image_path != 'No data' else 'images/placeholder.png') }}" alt="{{ title }}">
      <div class="text">
        <p>{{ artist_info }}</p>
      </div>
    </div>
    <h2>Object Information</h2>
    <form method="POST" action="{{ url_for('submit_review') }}">

      <table class="property-table">
        <thead>
  <tr>
    <th data-col="0" class="sortable">Property ▲▼</th>
    <th>Value</th>
    <th data-col="2" class="sortable">Status ▲▼</th>
    <th data-col="3" class="sortable">Comment ▲▼</th>
  </tr>
</thead>
        <tbody> {% for row in table_rows %} <tr>
            <td>{{ row.property }}</td>
            <td class="value-cell" data-value="{{ row.value }}" data-status="{{ row.status or 'gray' }}">
              <span class="value-text"> {% if row.value is string and row.value.startswith("http") %} <a href="{{ row.value }}" target="_blank">{{ row.value }}</a> {% else %} {{ row.value }} {% endif %} </span>
              <!-- Hidden textarea (shown in edit mode) -->
              <textarea class="value-editor" name="value_{{ loop.index }}" style="display:none; width:100%; box-sizing:border-box;" rows="3">{{ row.value }}</textarea>
            </td>
            <!-- ✅ EDITABLE TRAFFIC LIGHT -->
            <td style="text-align:center;"> {% set color = row.status if row.status else 'gray' %} <div class="traffic-light {{ color }}" id="light_{{ loop.index }}" onclick="cycleLight('{{ loop.index }}')"></div>
              <input type="hidden" name="status_{{ row.property }}" id="traffic_{{ loop.index }}" value="{{ color }}">
            </td>
            <td>
              <textarea name="comment_{{ row.property }}" rows="3" style="width:100%; box-sizing:border-box; font-size:14px;" placeholder="Write a comment here...">{{ row.comment if row.comment else "" }}</textarea>
            </td>
          </tr> {% endfor %} </tbody>
      </table>

      <div class="btn-container" style="text-align:center; margin:25px 0;">

  <!-- Action buttons -->
  <button type="button" class="btn btn-edit" id="editBtn" onclick="enableEditMode()">Edit</button>
  <button type="button" class="btn btn-save" id="saveBtn" onclick="saveChanges()">Save</button>
  <button type="button" class="btn btn-refresh" onclick="refreshData()">Refresh</button>

  <!-- Submit Review with Recipient Dropdown -->
  <select name="recipient_group" required style="margin-left:10px; padding:5px;">
    <option value="" disabled selected>Select Reviewer</option>
    <option value="administration">Administrator</option>
    <option value="reviewers">Reviewers</option>
    <option value="lawyer">Lawyers</option>
  </select>

  <button type="submit" class="btn btn-review" style="margin-left:5px;">Submit Review</button>

</div>


    </form>
    <footer class="site">
      <div class="footer-title">Antiziganismus und Ambivalenz in Europa</div>
      <nav class="footer">
        <a href="{{ url_for('contact') }}">Contact</a>
        <a href="{{ url_for('supporters') }}">Supporters</a>
        <a href="{{ url_for('imprint') }}">Imprint</a>
        <a href="{{ url_for('privacy') }}">Privacy statement</a>
      </nav>
    </footer>
    <script>
      function cycleLight(id) {
        const light = document.getElementById("light_" + id);
        const hidden = document.getElementById("traffic_" + id);
        const order = ["gray", "yellow", "green", "red"];
        const current = hidden.value || "gray";
        const next = order[(order.indexOf(current) + 1) % order.length];
        hidden.value = next;
        light.classList.remove("gray", "yellow", "green", "red");
        light.classList.add(next);
      }
    </script>
    <script>
        function enableEditMode() {
  document.getElementById("editBtn").disabled = true;

  document.querySelectorAll(".value-cell").forEach(cell => {
    const status = cell.dataset.status;           // red, yellow, green, gray
    const textSpan = cell.querySelector(".value-text");
    const textarea = cell.querySelector(".value-editor");

    if (status === "yellow" || status === "red" || status === "green") {
      textSpan.style.display = "none";
      textarea.style.display = "block";

      // Add status class for background
      textarea.classList.add(status);
      cell.classList.add(status);
    }
  });
}



 function saveChanges() {
  const objectName = "{{ neo4j_name }}";
  const rows = [];

  function neo4jSafeProp(prop) {
    return prop
      .trim()
      .replace(/ /g, "_")
      .replace(/\//g, "_")
      .replace(/\*/g, "")
      .replace(/:/g, "")
      .replace(/-/g, "_");
  }

  document.querySelectorAll(".value-cell").forEach(cell => {
    const property = cell.parentElement.querySelector("td:first-child").innerText.trim();
    const textarea = cell.querySelector(".value-editor");
    const textSpan = cell.querySelector(".value-text");
    const trafficInput = cell.parentElement.querySelector("input[type=hidden]");
    const status = trafficInput ? trafficInput.value : "";
    const value = textarea ? textarea.value.trim() : textSpan.innerText.trim();

    rows.push({
      property: property,
      prop_key: neo4jSafeProp(property),  // ✅ now works
      value: value || "",
      status: status
    });
  });

  const nodeType = "{{ table_rows[0].nodeType or 'Painting' }}";

  fetch(`/update_object/${encodeURIComponent(objectName)}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ rows, nodeType })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      alert("✅ Data saved successfully!");
      window.location.reload();
    } else {
      alert("❌ Error saving data: " + data.error);
    }
  })
  .catch(err => alert("❌ Error: " + err));
}


  function refreshData() {
    window.location.reload();
  }

  const sortState = {}; // remembers asc / desc per column

  const STATUS_ORDER = {
    red: 0,
    yellow: 1,
    gray: 2,
    green: 3
  };

  document.querySelectorAll("th.sortable").forEach(th => {
    th.addEventListener("click", () => {
      const colIndex = parseInt(th.dataset.col);
      sortTable(colIndex);
    });
  });

  function sortTable(colIndex) {
    const table = document.querySelector(".property-table tbody");
    const rows = Array.from(table.querySelectorAll("tr"));

    sortState[colIndex] = !sortState[colIndex];
    const asc = sortState[colIndex];

    rows.sort((a, b) => {
      let A, B;

      // COLUMN 1: Property
      if (colIndex === 0) {
        A = a.children[0].innerText.toLowerCase();
        B = b.children[0].innerText.toLowerCase();
      }

      // COLUMN 3: Status (traffic light)
      else if (colIndex === 2) {
        A = a.querySelector(".traffic-light").classList;
        B = b.querySelector(".traffic-light").classList;

        A = [...A].find(c => STATUS_ORDER.hasOwnProperty(c)) || "gray";
        B = [...B].find(c => STATUS_ORDER.hasOwnProperty(c)) || "gray";

        return asc
          ? STATUS_ORDER[A] - STATUS_ORDER[B]
          : STATUS_ORDER[B] - STATUS_ORDER[A];
      }

      // COLUMN 4: Comment (textarea content)
      else if (colIndex === 3) {
        A = a.children[3].querySelector("textarea").value.toLowerCase();
        B = b.children[3].querySelector("textarea").value.toLowerCase();
      }

      if (A < B) return asc ? -1 : 1;
      if (A > B) return asc ? 1 : -1;
      return 0;
    });

    rows.forEach(row => table.appendChild(row));
  }

         // <-- Add this at the end of your script
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".value-cell").forEach(cell => {
      const status = cell.dataset.status;
      cell.classList.add(status); // applies background color immediately
    });
  });

    </script>
  </body>
</html>