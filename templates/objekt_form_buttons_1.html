<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Objekt Informationen</title>
<style>
body { font-family: Arial; background:#fafafa; padding:40px; }
table.property-table { width:100%; border-collapse:collapse; background:#fff; margin-top:10px; }
th,td { border:1px solid #ccc; padding:8px; vertical-align:top; }
.col1{width:25%;background:#f9f9f9;font-weight:bold;}
.col2{width:45%;}
.col3{width:10%;text-align:center;}
.col4{width:20%;}
textarea{width:100%;min-height:50px;padding:6px;font-size:14px;border:1px solid #bbb;border-radius:4px;resize:vertical;}
.submit-btn,.add-row-btn,.upload-btn,.entity-button{
    margin-top:10px;padding:8px 15px;border:none;border-radius:4px;font-size:14px;cursor:pointer;}
.submit-btn{background:#4CAF50;color:white;}
.add-row-btn{background:#2196F3;color:white;margin-right:10px;}
.upload-btn{background:#FF9800;color:white;margin-right:10px;}
.entity-button{background:#e7f4ff;color:#005b8f;margin:2px 2px;border:1px solid #80cfff;border-radius:4px;}
.traffic-light{width:20px;height:20px;border-radius:50%;display:inline-block;margin-left:5px;border:1px solid #999;cursor:pointer;}
.red{background:red;} .yellow{background:yellow;} .green{background:green;}
</style>
</head>
<body>

<h2>Objekt Informationen</h2>

<!-- Upload Excel -->
<form method="POST" action="{{ url_for('add_data_upload') }}" enctype="multipart/form-data">
    <input type="file" name="file" accept=".xlsx" required>
    <button type="submit" class="upload-btn">Excel importieren</button>
</form>
<hr>

<!-- Main Form -->
<form id="mainForm" method="POST" action="{{ url_for('add_data_submit') }}">
    {% if source_node_id %}
        <input type="hidden" name="source_node_id" value="{{ source_node_id }}">
    {% endif %}
    {% if relation_name %}
        <input type="hidden" name="relation_name" value="{{ relation_name }}">
    {% endif %}

<table class="property-table">
<thead>
<tr><th class="col1">Property</th><th class="col2">Value</th><th class="col3">Status</th><th class="col4">Name Entities</th></tr>
</thead>
<tbody>
{% for field in fields %}
<tr>
<td class="col1">{{ field }}</td>
<td class="col2">
    {% set val = data.get(field,'') %}
    <textarea name="{{ field }}">{{ val }}</textarea>
</td>
<td class="col3">
    {% set color = colors.get(field,'red') %}
    <div class="traffic-light {{ color }}" id="light_{{ field|replace(' ','_') }}"
        onclick="cycleLight('{{ field|replace(' ','_') }}')"></div>
    <input type="hidden" id="traffic_{{ field|replace(' ','_') }}" name="traffic_{{ field }}" value="{{ color }}">
</td>
<td class="col4">
    {% for e in name_entities.get(field, []) %}
        <button type="button" class="entity-button"
            onclick="window.location='{{ url_for('add_data_open_entity_form',
                relation=field|urlencode,
                source_node_id=data.get('Objekt-ID','1')|urlencode,
                entity_name=e|urlencode) }}'">{{ e }}</button>
    {% else %}
        <span style="color:#999;">‚Äì</span>
    {% endfor %}
</td>
</tr>
{% endfor %}
</tbody>
</table>

<div>
    <button type="button" class="add-row-btn" onclick="addRow()">‚ûï Neues Feld</button>
    <button type="submit" formaction="{{ url_for('add_data_extract_entities') }}" formmethod="post" class="add-row-btn">üîç Name Entities extrahieren</button>
    <button type="button" class="submit-btn" onclick="saveData()">üíæ Daten speichern</button>
    <button type="button" class="add-row-btn" onclick="clearForm()">‚ûï Neuer Eintrag</button>
</div>
<p id="saveMessage" style="margin-top:15px;color:green;font-weight:bold;"></p>
</form>

<script>
let customIndex=0;
function cycleLight(f){
 const l=document.getElementById("light_"+f);
 const h=document.getElementById("traffic_"+f);
 const c=h.value;
 const next=c==="red"?"yellow":c==="yellow"?"green":"red";
 h.value=next;
 l.classList.remove("red","yellow","green");
 l.classList.add(next);
}
function addRow(){
 customIndex++;
 const table=document.querySelector('.property-table tbody');
 const r=document.createElement('tr');
 r.innerHTML=`<td class="col1"><input type="text" name="custom_property_${customIndex}" placeholder="Neues Property"></td>
 <td class="col2"><textarea name="custom_value_${customIndex}" rows="3"></textarea></td>
 <td class="col3"><div class="traffic-light red" id="light_custom_${customIndex}" onclick="cycleLight('custom_${customIndex}')"></div>
 <input type="hidden" name="traffic_custom_${customIndex}" id="traffic_custom_${customIndex}" value="red"></td>
 <td class="col4"><span style='color:#999;'>‚Äì</span></td>`;
 table.appendChild(r);
}
async function saveData(){
 const form=document.getElementById('mainForm');
 const fd=new FormData(form);
 try{
  const res=await fetch(form.action,{method:'POST',body:fd});
  document.getElementById('saveMessage').textContent="‚úÖ Daten erfolgreich gespeichert!";
 }catch(e){
  console.error(e);
  document.getElementById('saveMessage').textContent="‚ùå Fehler beim Speichern!";
 }
}
function clearForm(){
 document.querySelectorAll("textarea").forEach(t=>t.value="");
 document.querySelectorAll(".traffic-light").forEach(l=>{l.classList.remove("yellow","green");l.classList.add("red");});
 document.querySelectorAll("input[type=hidden]").forEach(i=>{if(i.name.startsWith("traffic_")) i.value="red";});
 document.getElementById("saveMessage").textContent="";
}
</script>

</body>
</html>
