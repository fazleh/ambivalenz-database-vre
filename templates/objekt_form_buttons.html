<!DOCTYPE html>
<html class="no-js" lang="en">
   <head>
      <meta http-equiv="content-type" content="text/html; charset=UTF-8">
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>Picture Narratives and Visual Staging of Antigypsy Motifs</title>
      <meta name="description" content="">
      <meta name="HandheldFriendly" content="True">
      <meta name="MobileOptimized" content="320">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="cleartype" content="on">
      <meta name="google-site-verification" content="5mewDMRKHpmN4nOFNMBcL74PmpSCkHIAstEhMHTHDjk">
      <title>Neo4j Flask App</title>
      <link rel="stylesheet" href="{{ url_for('static', filename='css/screen.css') }}">
      <script src="{{ url_for('static', filename='js/jquery-3.1.1.min.js') }}"></script>
      <script src="{{ url_for('static', filename='js/jquery.detect_swipe.js') }}"></script>
      <script src="{{ url_for('static', filename='js/helper.js') }}"></script>
      <script src="{{ url_for('static', filename='js/main.js') }}"></script>
      <!--[if lt IE 9]>
      <script src="/static/js/vendor/html5shiv.min.js"></script>
      <![endif]-->
       <meta charset="UTF-8">
<style>
   /* ===== GLOBAL ===== */
body {
  margin: 0;
  font-family: Arial;
  background: #e0e0e0; /* fallback */
}

/* ===== HEADER & FOOTER ===== */
header.site,
footer.site {
  background: #000;
  color: #fff;
}

header.site a,
footer.site a {
  color: #fff;
}

/* keep logos visible */
header.site img,
footer.site img {
  filter: brightness(0) invert(1);
}

/* ===== MIDDLE CONTENT AREA ===== */
.main-content {
  background: #f2f2f2;   /* gray middle */
  padding: 40px;
  min-height: calc(100vh - 240px);
}

/* tables remain white */
table.property-table {
  background: #fff;
}

/* footer spacing */
footer.site {
  padding: 30px 20px;
}

/* ===== BEAUTIFUL TABLE ===== */
table.property-table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  margin-top: 20px;
  border: 2px solid #444;               /* strong outer border */
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

/* header row */
table.property-table thead th {
  background: #222;
  color: #fff;
  font-weight: bold;
  padding: 12px;
  border: 1px solid #444;
  text-align: left;
}

/* table cells */
table.property-table th,
table.property-table td {
  border: 1px solid #999;               /* visible grid lines */
  padding: 10px;
  vertical-align: top;
  font-size: 14px;
}

/* column styles */
.col1 {
  width: 25%;
  background: #f4f4f4;
  font-weight: bold;
}

.col2 { width: 45%; }
.col3 { width: 10%; text-align: center; }
.col4 { width: 20%; }

/* zebra striping */
table.property-table tbody tr:nth-child(even) {
  background: #fafafa;
}

/* hover highlight */
table.property-table tbody tr:hover {
  background: #eef5ff;
}

/* textarea polish */
table.property-table textarea {
  width: 100%;
  min-height: 60px;
  padding: 8px;
  font-size: 14px;
  border: 1px solid #aaa;
  border-radius: 6px;
  resize: vertical;
}

table.property-table textarea:focus {
  outline: none;
  border-color: #2196F3;
  box-shadow: 0 0 0 2px rgba(33,150,243,0.15);
}


textarea{width:100%;min-height:50px;padding:6px;font-size:14px;border:1px solid #bbb;border-radius:4px;resize:vertical;}
.submit-btn,.add-row-btn,.upload-btn,.entity-button{
    margin-top:10px;padding:8px 15px;border:none;border-radius:4px;font-size:14px;cursor:pointer;}
.submit-btn{background:#4CAF50;color:white;}
.add-row-btn{background:#2196F3;color:white;margin-right:10px;}
.upload-btn{background:#FF9800;color:white;margin-right:10px;}
.entity-button{background:#e7f4ff;color:#005b8f;margin:2px 2px;border:1px solid #80cfff;border-radius:4px;}
.traffic-light{width:20px;height:20px;border-radius:50%;display:inline-block;margin-left:5px;border:1px solid #999;cursor:pointer;}
.red{background:red;} .yellow{background:yellow;} .green{background:green;} .gray{background:#ccc;}
.delete-btn { background: #c62828; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; }
.delete-btn:hover { background: #b71c1c; }
</style>
   </head>
   <body class=" site-page frontpage">
      <!--[if lt IE 8]>
      <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
      <![endif]-->
      <header class="site">
         <a id="header-logo" href="http://127.0.0.1:5000/">
         <img class="logo" srcset="{{ url_for('static', filename='images/Uni_Marburg_Siegel.png') }} 57w,
            {{ url_for('static', filename='images/Uni_Marburg_Siegel.png') }} 93w,
            {{ url_for('static', filename='images/Uni_Marburg_Siegel.png') }} 103w"
            src="{{ url_for('static', filename='images/Uni_Marburg_Siegel.png') }}" alt="Uni Marburg Logo">
         </a>
         <div class="header-language-switcher">
            <span class="current-language">EN</span>
         </div>
         <h1 id="header-title">
            <a href="http://127.0.0.1:5000/" title="RomArchive">Antiziganismus und Ambivalenz in Europa</a>
         </h1>
         <div id="header-tools">
            <a id="search" href="http://127.0.0.1:5000/search/">
            <img src="{{ url_for('static', filename='images/search.svg') }}" alt="Search"></a>
            <div id="hamburger">
               <img class="hamburger" src="{{ url_for('static', filename='images/menu-open.svg') }}">
            </div>
         </div>
      </header>
      <div id="menu" class="menu">
         <img class="logo" srcset="{{ url_for('static', filename='RomArchive_files/Uni_Marburg_Siegel.png') }} 57w,
            {{ url_for('static', filename='RomArchive_files/Uni_Marburg_Siegel.png') }} 93w,
            {{ url_for('static', filename='RomArchive_files/Uni_Marburg_Siegel.png') }} 103w"
            src="{{ url_for('static', filename='RomArchive_files/Uni_Marburg_Siegel.png') }}">
         <nav class="site">
            <h1 id="header-title-menu" class="box clickable-box"><a class="box-link" href="http://127.0.0.1:5000/">Antiziganismus und Ambivalenz in Europa</a></h1>
            <ul class="menu">
               <li class="box clickable-box">
                  <a class="box-link" href="http://127.0.0.1:5000/">Home</a>
               </li>
               <li class="submenu collapsed">
                  <div class="box submenu-header clickable-box">
                     <a class="box-link" href="http://127.0.0.1:5000/sections/">Curated sections</a>
                     <button class="collapse"><img src="{{ url_for('static', filename='images/open-vertical.svg') }}" alt="collapse"></button>
                  </div>
                  <ul class="menu">
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('add_data') }}">Add Data</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('manage_data') }}">Manage Data</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('visual_art') }}">Painting</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('poster') }}">Poster</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('portrait') }}">Portrait</a></li>
                     <!--li class="box clickable-box"><a class="box-link" href="{{ url_for('audio') }}">Audio</a></li-->
                     <!--li class="box clickable-box"><a class="box-link" href="{{ url_for('video') }}">Video</a></li-->
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('book') }}">Book</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('article') }}">Scientific Article</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('song') }}">Song</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('poem') }}">Poem</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('legal_text') }}">Legal Text</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('Person') }}">Person</a></li>

                     <li class="box clickable-box"><a class="box-link" href="http://127.0.0.1:7474/browser/">Graph</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('Metadata') }}">Metadata</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('logout') }}">Logout</a></li>
                     <!-- External URL is fine -->
                  </ul>
               </li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('add_data') }}">Add Data</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('manage_data') }}">Manage Data</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('visual_art') }}">Painting</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('poster') }}">Poster</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('portrait') }}">Portrait</a></li>
               <!--li class="box clickable-box"><a class="box-link" href="{{ url_for('audio') }}">Audio</a></li-->
               <!--li class="box clickable-box"><a class="box-link" href="{{ url_for('video') }}">Video</a></li-->
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('book') }}">Book</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('article') }}">Scientific Article</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('song') }}">Song</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('poem') }}">Poem</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('legal_text') }}">Legal Text</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('Person') }}">Person</a></li>

               <li class="box clickable-box"><a class="box-link" href="http://127.0.0.1:7474/browser/">Graph</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('Metadata') }}">Metadata</a></li>
               <li class="box clickable-box"><a class="box-link" href="{{ url_for('logout') }}">Logout</a></li>
               <!-- External URL is fine -->
               <li class="secondary submenu collapsed">
                  <div class="box submenu-header clickable-box">
                     <a class="box-link" href="{{ url_for('about') }}">About</a>
                     <button class="collapse"> <img src="{{ url_for('static', filename='images/open-vertical.svg') }}" alt="collapse"></button>
                  </div>
                  <ul class="menu">
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('context_project') }}">Roma: Who Are We?</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('history_of_romarchive') }}">Idea - Advisory Board - Team</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('curators') }}">Archive Sections and Curators</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('ethical_guidelines') }}">RomArchive Ethical Guidelines*</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('collection_policy') }}">Collection Policy</a></li>
                     <li class="box clickable-box"><a class="box-link" href="{{ url_for('faq') }}">Frequently Asked Questions | FAQ</a></li>
                  </ul>
               </li>
               <li class="box secondary clickable-box"><a class="box-link" href="{{ url_for('search') }}">Search</a></li>
               <li class="box secondary clickable-box"><a class="box-link" href="{{ url_for('terms') }}">Terms</a></li>
               <li class="box secondary clickable-box"><a class="box-link" href="{{ url_for('contact') }}">Contact</a></li>
            </ul>
         </nav>
      </div>

<div class="main-content">

<!-- Upload Excel -->
<!-- Upload Excel / ODS -->
<form method="POST" action="{{ url_for('add_data_upload') }}" enctype="multipart/form-data">
    <input type="file" name="file"
           accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,
                   .ods,application/vnd.oasis.opendocument.spreadsheet"
           required>
    <button type="submit" class="upload-btn">Excel / ODS importieren</button>
</form>


<hr>

<!-- Upload Attachment -->
<form id="attachmentUploadForm" method="POST" action="{{ url_for('add_attachment_upload') }}" enctype="multipart/form-data">
  <label for="attachment">Anh√§nge hochladen (z. B. Bilder, PDFs):</label>
  <input type="file" name="attachment" id="attachment" accept="*/*" required>
  <button type="submit" class="upload-btn">Anhang hochladen</button>
</form>

<hr>

<label for="objectType">Objekt Typ ausw√§hlen:</label>
<select id="objectType" onchange="fillFields()">
    <option value="">-- Bitte w√§hlen --</option>
        <option value="Article">Article</option>
        <option value="LegalText">LegalText</option>
        <option value="Literature">Literature</option>
        <option value="Painting">Painting</option>
        <option value="Person">Person</option>
        <option value="Portrait">Portrait</option>
        <option value="Poster">Poster</option>
        <option value="Poem">Poem</option>
        <option value="Song">Song</option>
        <option value="Scientific-Article">Scientific Article</option>
</select>

<!-- Main Form -->
<form id="mainForm" method="POST" action="{{ url_for('add_data_submit') }}">
    {% if source_node_id %}
        <input type="hidden" name="source_node_id" value="{{ source_node_id }}">
    {% endif %}
    {% if relation_name %}
        <input type="hidden" name="relation_name" value="{{ relation_name }}">
    {% endif %}

<table class="property-table">
<thead>
<tr><th class="col1">Property</th><th class="col2">Value</th><th class="col3">Status</th><th class="col4">Name Entities</th></tr>
</thead>
<tbody>
<tr>
  <td class="col1">nodeType *</td>

  <td class="col2">
    <select name="nodeType" id="nodeTypeSelect" required>
        <option value="Article">Article</option>
        <option value="Book">Book</option>
        <option value="LegalText">LegalText</option>
        <option value="Literature">Literature</option>
        <option value="Painting">Painting</option>
        <option value="Person">Person</option>
        <option value="Portrait">Portrait</option>
        <option value="Poster">Poster</option>
        <option value="Poem">Poem</option>
        <option value="Song">Song</option>
        <option value="Scientific-Article">Scientific Article</option>
    </select>
  </td>

  <td class="col3">
    <div class="traffic-light yellow"></div>
  </td>

  <td class="col4">‚Äì</td>
</tr>

{% for field in fields %}
<tr>
<td class="col1">{{ field }}</td>
<td class="col2">
    {% set val = data.get(field, '') %}
    <textarea name="{{ field }}">{{ val }}</textarea>
</td>
<td class="col3">
    {# Use user-chosen color if present; otherwise yellow if value present, else gray #}
    {% if val %}
    {% if field in colors and colors[field] %}
        {% set color = colors[field] %}
    {% else %}
        {% set color = 'yellow' %}
    {% endif %}
{% else %}
    {% set color = 'gray' %}
{% endif %}


    <div class="traffic-light {{ color }}"
         id="light_{{ field|replace(' ','_') }}"
         onclick="cycleLight('{{ field|replace(' ','_') }}')"></div>

    <input type="hidden"
           id="traffic_{{ field|replace(' ','_') }}"
           name="traffic_{{ field }}"
           value="{{ color }}">
</td>
<td class="col4">
    {% for e in name_entities.get(field, []) %}
        <button type="button" class="entity-button"
         onclick="saveAndOpenEntity('{{ field|urlencode }}', '{{ data.get('Objekt-ID','1')|urlencode }}', '{{ e|urlencode }}')">{{ e }}</button>
    {% else %}
        <span style="color:#999;">‚Äì</span>
    {% endfor %}
</td>
</tr>
{% endfor %}
</tbody>
</table>

<div>
    <button type="button" class="add-row-btn" onclick="addRow()">‚ûï Neues Feld</button>
    <button type="submit" formaction="{{ url_for('add_data_extract_entities') }}" formmethod="post" class="add-row-btn">üîç Name Entities extrahieren</button>
    <button type="button" class="submit-btn" onclick="saveData()">üíæ Daten speichern</button>
    <button type="button" class="add-row-btn" onclick="clearForm()">‚ûï Neuer Eintrag</button>
</div>
<p id="saveMessage" style="margin-top:15px;color:green;font-weight:bold;"></p>
</form>

<script>
(function () {
  let customIndex = 0;
  const KB = 1024;

  function readableSize(bytes) {
    if (!bytes && bytes !== 0) return "";
    if (bytes < KB) return bytes + " B";
    if (bytes < KB * KB) return (bytes / KB).toFixed(1) + " KB";
    return (bytes / (KB * KB)).toFixed(1) + " MB";
  }

  const fieldsByType = {
    "Painting": ["Objekt-ID","Titel","K√ºnstler*in/Autor*in","Versionsgeschichte"],
    "Portrait": ["Objekt-ID","Titel","Versionsgeschichte"],
    "Person": ["Varianter Name","Titel","Literatur"],
    "LegalText": ["Objekt-ID","Titel","Versionsgeschichte"],
    "Literature": ["Objekt-ID","Titel","Versionsgeschichte"]
  };

  function fillFields() {
    const typeSelect = document.getElementById("objectType");
    const selectedType = typeSelect ? typeSelect.value : "";
    // sync nodeType dropdown
const nodeTypeSelect = document.getElementById("nodeTypeSelect");
if (nodeTypeSelect && selectedType) {
  nodeTypeSelect.value = selectedType;
}

    const tableBody = document.querySelector('.property-table tbody');
    if (!tableBody) return;
    tableBody.innerHTML = "";

    if (!selectedType) return;
    const fields = fieldsByType[selectedType] || [];

    fields.forEach(field => {
      const fid = field.replace(/ /g,'_');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="col1">${field}</td>
        <td class="col2"><textarea name="${field}"></textarea></td>
        <td class="col3">
          <div class="traffic-light gray" id="light_${fid}"
               onclick="cycleLight('${fid}')"></div>
          <input type="hidden" id="traffic_${fid}" name="traffic_${field}" value="gray">
        </td>
        <td class="col4"><span style='color:#999;'>‚Äì</span></td>
      `;
      tableBody.appendChild(row);
    });
  }
  window.fillFields = fillFields;

  function cycleLight(f) {
  const l = document.getElementById("light_" + f);
  const h = document.getElementById("traffic_" + f);
  if (!l || !h) return;

  /* üîí CHECK VALUE FIELD */
  const row = l.closest("tr");
  const textarea = row?.querySelector("td.col2 textarea, td.col2 input:not([readonly])");
  const value = textarea ? textarea.value.trim() : "";

  /* ‚õî EMPTY ‚Üí FORCE GRAY */
  if (!value) {
    h.value = "gray";
    l.classList.remove("red", "yellow", "green", "gray");
    l.classList.add("gray");
    return;
  }

  /* NORMAL CYCLING */
  const c = h.value;
  let next;
  if (c === "gray") next = "yellow";
  else if (c === "yellow") next = "green";
  else if (c === "green") next = "red";
  else next = "gray";

  h.value = next;
  l.classList.remove("red", "yellow", "green", "gray");
  l.classList.add(next);
}

  window.cycleLight = cycleLight;

  function addRow() {
    customIndex++;
    const table = document.querySelector('.property-table tbody');
    if (!table) return;
    const fid = "custom_" + customIndex;
    const r = document.createElement('tr');
    r.innerHTML = `<td class="col1"><input type="text" name="custom_property_${customIndex}" placeholder="Neues Property"></td>
      <td class="col2"><textarea name="custom_value_${customIndex}" rows="3"></textarea></td>
      <td class="col3">
        <div class="traffic-light gray" id="light_${fid}" onclick="cycleLight('${fid}')"></div>
        <input type="hidden" name="traffic_custom_${customIndex}" id="traffic_${fid}" value="gray">
      </td>
      <td class="col4"><span style='color:#999;'>‚Äì</span></td>`;
    table.appendChild(r);
  }

  window.addRow = addRow;

  async function saveData() {
    const form = document.getElementById('mainForm');
    if (!form) return;

    // ‚úÖ Check if nodeType is selected
    const nodeTypeSelect = document.getElementById('nodeTypeSelect');
    if (!nodeTypeSelect.value) {
        alert("‚ùå Bitte w√§hlen Sie den 'nodeType' aus, bevor Sie speichern."); // German message
        nodeTypeSelect.focus();
        return; // stop submission
    }

    const fd = new FormData(form);
    try {
        await fetch(form.action, { method: 'POST', body: fd });
        document.getElementById('saveMessage').textContent = "‚úÖ Daten erfolgreich gespeichert!";
    } catch (e) {
        console.error(e);
        document.getElementById('saveMessage').textContent = "‚ùå Fehler beim Speichern!";
    }
}

  window.saveData = saveData;

  function clearForm() {
    document.querySelectorAll("tbody tr").forEach(tr => {
      // skip readonly image_path rows
      if (tr.querySelector("td.col2 input[readonly]")) return;

      // find editable element (textarea or non-readonly input) in col2
      const input = tr.querySelector("td.col2 textarea, td.col2 input:not([readonly])");
      if (input) {
        if ('value' in input) input.value = "";
        else input.textContent = "";
      }

      // traffic light element and corresponding hidden input
      const light = tr.querySelector(".traffic-light");
      const hidden = tr.querySelector("input[type=hidden][id^='traffic_'], input[type=hidden][name^='traffic_']");

      if (light) {
        light.classList.remove("red", "yellow", "green", "gray");
        light.classList.add("gray");
      }
      if (hidden) hidden.value = "gray";
    });

    const msg = document.getElementById("saveMessage");
    if (msg) msg.textContent = "";
  }
  window.clearForm = clearForm;

  async function saveAndOpenEntity(field, sourceNodeId, entityName) {
    const form = document.getElementById('mainForm');
    if (!form) return;
    const fd = new FormData(form);
    try {
      await fetch(form.action, { method: 'POST', body: fd });
      document.getElementById('saveMessage').textContent = "‚úÖ Daten erfolgreich gespeichert!";
      const url = `{{ url_for('add_data_open_entity_form') }}?relation=${field}&source_node_id=${sourceNodeId}&entity_name=${entityName}`;
      window.location.href = url;
    } catch (e) {
      console.error(e);
      document.getElementById('saveMessage').textContent = "‚ùå Fehler beim Speichern!";
    }
  }
  window.saveAndOpenEntity = saveAndOpenEntity;

  function getFileIcon(url, filename) {
    const ext = (filename || "").split('.').pop().toLowerCase();
    if(["jpg","jpeg","png","gif","webp"].includes(ext)) return `<img src="${url}" style="height:50px;border-radius:6px;">`;
    if(ext==="pdf") return `<span style="font-size:24px;">üìÑ</span>`;
    return `<span style="font-size:24px;">üìé</span>`;
  }

  function insertAttachmentRow(url, filename, size, rowId) {
    const tableBody = document.querySelector(".property-table tbody");
    if(!tableBody) return;
    const readable = readableSize(size);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="col1">Anhang</td>
      <td class="col2"><a href="${url}" target="_blank">${filename}</a>${readable ? `<br><small>${readable}</small>` : ''}</td>
      <td class="col3">
        <div class="traffic-light green" id="light_${rowId}" onclick="cycleLight('${rowId}')"></div>
        <input type="hidden" name="traffic_${rowId}" value="green">
      </td>
      <td class="col4">‚Äì</td>
    `;
    tableBody.insertBefore(row, tableBody.firstChild);
  }

  function insertImagePathRow(filePath) {
    const tableBody = document.querySelector(".property-table tbody");
    if (!tableBody) return;
    const rowId = "image_path_" + Date.now();
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="col1">image_path</td>
      <td class="col2"><input type="text" value="${filePath}" readonly></td>
      <td class="col3">
        <div class="traffic-light green" id="light_${rowId}" onclick="cycleLight('${rowId}')"></div>
        <input type="hidden" name="traffic_${rowId}" id="traffic_${rowId}" value="green">
      </td>
      <td class="col4">‚Äì</td>
    `;
    tableBody.insertBefore(row, tableBody.firstChild);
  }

  function bindAttachmentUpload() {
    const form = document.getElementById("attachmentUploadForm");
    if(!form || form.__bound) return;
    form.__bound = true;

    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      const fileInput = form.querySelector("input[type='file']");
      if(!fileInput || !fileInput.files.length){
        alert("‚ùå No file selected");
        return;
      }

      const fd = new FormData();
      fd.append("attachment", fileInput.files[0]);

      try {
        const res = await fetch(form.action, { method: "POST", body: fd });
        const data = await res.json();
        if(!data.success){
          alert("Fehler beim Hochladen");
          return;
        }

        const objectID = document.querySelector("textarea[name='Objekt-ID']")?.value || "unknown";
        const title = document.querySelector("textarea[name='Titel']")?.value || "title";
        const safeTitle = title.replace(/\s+/g,'_');
        const autoFilename = `${objectID}_${safeTitle}${data.extension || '.png'}`;
        const filePath = `static/private/${autoFilename}`;

        insertAttachmentRow(data.url, data.filename, data.size, "attachment_" + Date.now());
        insertImagePathRow(filePath);

      } catch(err){
        console.error(err);
        alert("Fehler beim Hochladen.");
      }
    });
  }

  function init() {
    bindAttachmentUpload();
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  window.__appHelpers = { insertAttachmentRow, insertImagePathRow, readableSize };
})();
</script>

</div>
      <footer class="site">
         <div class="footer-title">Antiziganismus und Ambivalenz in Europa</div>
         <nav class="footer">
            <a href="{{ url_for('contact') }}">Contact</a>
            <a href="{{ url_for('supporters') }}">Supporters</a>
            <a href="{{ url_for('imprint') }}">Imprint</a>
            <a href="{{ url_for('privacy') }}">Privacy statement</a>
         </nav>
      </footer>
   </body>
</html>
