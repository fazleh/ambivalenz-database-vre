<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Objekt Informationen</title>
<style>
body { font-family: Arial; background:#fafafa; padding:40px; }
table.property-table { width:100%; border-collapse:collapse; background:#fff; margin-top:10px; }
th,td { border:1px solid #ccc; padding:8px; vertical-align:top; }
.col1{width:25%;background:#f9f9f9;font-weight:bold;}
.col2{width:45%;}
.col3{width:10%;text-align:center;}
.col4{width:20%;}
textarea{width:100%;min-height:50px;padding:6px;font-size:14px;border:1px solid #bbb;border-radius:4px;resize:vertical;}
.submit-btn,.add-row-btn,.upload-btn,.entity-button{
    margin-top:10px;padding:8px 15px;border:none;border-radius:4px;font-size:14px;cursor:pointer;}
.submit-btn{background:#4CAF50;color:white;}
.add-row-btn{background:#2196F3;color:white;margin-right:10px;}
.upload-btn{background:#FF9800;color:white;margin-right:10px;}
.entity-button{background:#e7f4ff;color:#005b8f;margin:2px 2px;border:1px solid #80cfff;border-radius:4px;}
.traffic-light{width:20px;height:20px;border-radius:50%;display:inline-block;margin-left:5px;border:1px solid #999;cursor:pointer;}
.red{background:red;} .yellow{background:yellow;} .green{background:green;} .gray{background:gray;}

</style>

<style>
.delete-btn {
    background: #c62828;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
}
.delete-btn:hover {
    background: #b71c1c;
}
</style>


</head>
<body>

<h2>Objekt Informationen</h2>

<!-- Upload Excel -->
<form method="POST" action="{{ url_for('add_data_upload') }}" enctype="multipart/form-data">
    <input type="file" name="file" accept=".xlsx" required>
    <button type="submit" class="upload-btn">Excel importieren</button>
</form>

<hr>

<!-- Upload Attachment -->
<form id="attachmentUploadForm" method="POST" action="{{ url_for('add_attachment_upload') }}" enctype="multipart/form-data">
  <label for="attachment">Anh√§nge hochladen (z. B. Bilder, PDFs):</label>
  <input type="file" name="attachment" id="attachment" accept="*/*" required>
  <button type="submit" class="upload-btn">Anhang hochladen</button>
</form>

<hr>



<label for="objectType">Objekt Typ ausw√§hlen:</label>
<select id="objectType" onchange="fillFields()">
    <option value="">-- Bitte w√§hlen --</option>
    <option value="LegalText">LegalText</option>
    <option value="Literature">Literature</option>
    <option value="Painting">Painting</option>
    <option value="Person">Person</option>
    <option value="Portrait">Portrait</option>
</select>

<!-- Main Form -->
<form id="mainForm" method="POST" action="{{ url_for('add_data_submit') }}">
    {% if source_node_id %}
        <input type="hidden" name="source_node_id" value="{{ source_node_id }}">
    {% endif %}
    {% if relation_name %}
        <input type="hidden" name="relation_name" value="{{ relation_name }}">
    {% endif %}

<table class="property-table">
<thead>
<tr><th class="col1">Property</th><th class="col2">Value</th><th class="col3">Status</th><th class="col4">Name Entities</th></tr>
</thead>
<tbody>
{% for field in fields %}
<tr>
<td class="col1">{{ field }}</td>
<td class="col2">
    {% set val = data.get(field,'') %}
    <textarea name="{{ field }}">{{ val }}</textarea>
</td>
<td class="col3">
    {% set val = data.get(field, '') %}

    {% if field in colors %}
        {# User-chosen color exists ‚Üí use it #}
        {% set color = colors[field] %}
    {% else %}
        {# No user-selected color yet ‚Üí use logic #}
        {% if val %}
            {% set color = 'yellow' %}
        {% else %}
            {% set color = 'gray' %}
        {% endif %}
    {% endif %}

    <div class="traffic-light {{ color }}"
         id="light_{{ field|replace(' ','_') }}"
         onclick="cycleLight('{{ field|replace(' ','_') }}')"></div>

    <input type="hidden"
           id="traffic_{{ field|replace(' ','_') }}"
           name="traffic_{{ field }}"
           value="{{ color }}">
</td>

<td class="col4">
    {% for e in name_entities.get(field, []) %}
        <button type="button" class="entity-button"
         onclick="saveAndOpenEntity('{{ field|urlencode }}', '{{ data.get('Objekt-ID','1')|urlencode }}', '{{ e|urlencode }}')">{{ e }}</button>
    {% else %}
        <span style="color:#999;">‚Äì</span>
    {% endfor %}
</td>
</tr>
{% endfor %}
</tbody>
</table>

<div>
    <button type="button" class="add-row-btn" onclick="addRow()">‚ûï Neues Feld</button>
    <button type="submit" formaction="{{ url_for('add_data_extract_entities') }}" formmethod="post" class="add-row-btn">üîç Name Entities extrahieren</button>
    <button type="button" class="submit-btn" onclick="saveData()">üíæ Daten speichern</button>
    <button type="button" class="add-row-btn" onclick="clearForm()">‚ûï Neuer Eintrag</button>
</div>
<p id="saveMessage" style="margin-top:15px;color:green;font-weight:bold;"></p>
</form>

<!-- make sure your form tag is:
<form id="attachmentUploadForm" method="POST" action="{{ url_for('add_attachment_upload') }}" enctype="multipart/form-data">
-->
<script>
(function () {
  let customIndex = 0;
  const KB = 1024;

  function readableSize(bytes) {
    if (!bytes && bytes !== 0) return "";
    if (bytes < KB) return bytes + " B";
    if (bytes < KB * KB) return (bytes / KB).toFixed(1) + " KB";
    return (bytes / (KB * KB)).toFixed(1) + " MB";
  }

  const fieldsByType = {
    "Painting": ["Objekt-ID","Titel","K√ºnstler*in/Autor*in","Versionsgeschichte"],
    "Portrait": ["Objekt-ID","Titel","Versionsgeschichte"],
    "Person": ["Varianter Name","Titel","Literatur"],
    "LegalText": ["Objekt-ID","Titel","Versionsgeschichte"],
    "Literature": ["Objekt-ID","Titel","Versionsgeschichte"]
  };

  function fillFields() {
    const typeSelect = document.getElementById("objectType");
    const selectedType = typeSelect ? typeSelect.value : "";
    const tableBody = document.querySelector('.property-table tbody');
    if (!tableBody) return;
    tableBody.innerHTML = "";

    if (!selectedType) return;
    const fields = fieldsByType[selectedType] || [];

    fields.forEach(field => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="col1">${field}</td>
        <td class="col2"><textarea name="${field}"></textarea></td>
        <td class="col3">
          <div class="traffic-light gray" id="light_${field.replace(/ /g,'_')}"
               onclick="cycleLight('${field.replace(/ /g,'_')}')"></div>
          <input type="hidden" id="traffic_${field.replace(/ /g,'_')}" name="traffic_${field}" value="gray">
        </td>
        <td class="col4"><span style='color:#999;'>‚Äì</span></td>
      `;
      tableBody.appendChild(row);
    });
  }
  window.fillFields = fillFields;

  function cycleLight(f) {
    const l = document.getElementById("light_" + f);
    const h = document.getElementById("traffic_" + f);
    if (!l || !h) return;
    const c = h.value;
    const next = c === "red" ? "yellow" : c === "yellow" ? "green" : "red";
    h.value = next;
    l.classList.remove("red", "yellow", "green");
    l.classList.add(next);
  }
  window.cycleLight = cycleLight;

  function addRow() {
    customIndex++;
    const table = document.querySelector('.property-table tbody');
    if (!table) return;
    const r = document.createElement('tr');
    r.innerHTML = `<td class="col1"><input type="text" name="custom_property_${customIndex}" placeholder="Neues Property"></td>
      <td class="col2"><textarea name="custom_value_${customIndex}" rows="3"></textarea></td>
      <td class="col3">
        <div class="traffic-light gray" id="light_custom_${customIndex}" onclick="cycleLight('custom_${customIndex}')"></div>
        <input type="hidden" name="traffic_custom_${customIndex}" id="traffic_custom_${customIndex}" value="gray">
      </td>
      <td class="col4"><span style='color:#999;'>‚Äì</span></td>`;
    table.appendChild(r);
  }
  window.addRow = addRow;

  async function saveData() {
    const form = document.getElementById('mainForm');
    if (!form) return;
    const fd = new FormData(form);
    try {
      await fetch(form.action, { method: 'POST', body: fd });
      document.getElementById('saveMessage').textContent = "‚úÖ Daten erfolgreich gespeichert!";
    } catch (e) {
      console.error(e);
      document.getElementById('saveMessage').textContent = "‚ùå Fehler beim Speichern!";
    }
  }
  window.saveData = saveData;

  function clearForm() {
  // iterate rows
  document.querySelectorAll("tbody tr").forEach(tr => {
    // skip readonly image_path rows (those with an input[readonly] in col2)
    if (tr.querySelector("td.col2 input[readonly]")) return;

    // find any editable input in col2 (textarea or non-readonly input)
    const input = tr.querySelector("td.col2 textarea, td.col2 input:not([readonly])");
    if (input) {
      // clear the visible value
      if ('value' in input) input.value = "";
      else input.textContent = "";
    }

    // find the traffic light element and its hidden field (traffic_*)
    const light = tr.querySelector(".traffic-light");
    const hidden = tr.querySelector("input[type=hidden][id^='traffic_'], input[type=hidden][name^='traffic_']");

    if (light) {
      // remove any previous color classes and set gray
      light.classList.remove("red", "yellow", "green", "gray");
      light.classList.add("gray");
    }

    if (hidden) {
      hidden.value = "gray";
    }
  });

  const msg = document.getElementById("saveMessage");
  if (msg) msg.textContent = "";
}



  window.clearForm = clearForm;

  async function saveAndOpenEntity(field, sourceNodeId, entityName) {
    const form = document.getElementById('mainForm');
    if (!form) return;
    const fd = new FormData(form);
    try {
      await fetch(form.action, { method: 'POST', body: fd });
      document.getElementById('saveMessage').textContent = "‚úÖ Daten erfolgreich gespeichert!";
      const url = `{{ url_for('add_data_open_entity_form') }}?relation=${field}&source_node_id=${sourceNodeId}&entity_name=${entityName}`;
      window.location.href = url;
    } catch (e) {
      console.error(e);
      document.getElementById('saveMessage').textContent = "‚ùå Fehler beim Speichern!";
    }
  }
  window.saveAndOpenEntity = saveAndOpenEntity;

  function getFileIcon(url, filename) {
    const ext = (filename || "").split('.').pop().toLowerCase();
    if(["jpg","jpeg","png","gif","webp"].includes(ext)) return `<img src="${url}" style="height:50px;border-radius:6px;">`;
    if(ext==="pdf") return `<span style="font-size:24px;">üìÑ</span>`;
    return `<span style="font-size:24px;">üìé</span>`;
  }

  function insertAttachmentRow(url, filename, size, rowId) {
    const tableBody = document.querySelector(".property-table tbody");
    if(!tableBody) return;
    const readable = readableSize(size);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="col1">Anhang</td>
      <td class="col2"><a href="${url}" target="_blank">${filename}</a>${readable ? `<br><small>${readable}</small>` : ''}</td>
      <td class="col3">
        <div class="traffic-light green" id="light_${rowId}" onclick="cycleLight('${rowId}')"></div>
        <input type="hidden" name="traffic_${rowId}" value="green">
      </td>
      <td class="col4">‚Äì</td>
    `;
    tableBody.insertBefore(row, tableBody.firstChild);
  }

  function insertImagePathRow(filePath) {
  const tableBody = document.querySelector(".property-table tbody");
  if (!tableBody) return;
  const rowId = "image_path_" + Date.now();
  const row = document.createElement("tr");
  row.innerHTML = `
    <td class="col1">image_path</td>
    <td class="col2"><input type="text" value="${filePath}" readonly></td>
    <td class="col3">
      <div class="traffic-light green" id="light_${rowId}" onclick="cycleLight('${rowId}')"></div>
      <input type="hidden" name="traffic_${rowId}" id="traffic_${rowId}" value="green">
    </td>
    <td class="col4">‚Äì</td>
  `;
  tableBody.insertBefore(row, tableBody.firstChild);
}


  function bindAttachmentUpload() {
    const form = document.getElementById("attachmentUploadForm");
    if(!form || form.__bound) return;
    form.__bound = true;

    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      const fileInput = form.querySelector("input[type='file']");
      if(!fileInput || !fileInput.files.length){
        alert("‚ùå No file selected");
        return;
      }

      const fd = new FormData();
      fd.append("attachment", fileInput.files[0]);

      try {
        const res = await fetch(form.action, { method: "POST", body: fd });
        const data = await res.json();
        if(!data.success){
          alert("Fehler beim Hochladen");
          return;
        }

        const objectID = document.querySelector("textarea[name='Objekt-ID']")?.value || "unknown";
        const title = document.querySelector("textarea[name='Titel']")?.value || "title";
        const safeTitle = title.replace(/\s+/g,'_');
        const autoFilename = `${objectID}_${safeTitle}${data.extension || '.png'}`;
        const filePath = `static/private/${autoFilename}`;

        insertAttachmentRow(data.url, data.filename, data.size, "attachment_" + Date.now());
        insertImagePathRow(filePath);

      } catch(err){
        console.error(err);
        alert("Fehler beim Hochladen.");
      }
    });
  }

  function init() {
    bindAttachmentUpload();
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  window.__appHelpers = { insertAttachmentRow, insertImagePathRow, readableSize };
})();
</script>




</body>
</html>
